# Coppitï¼ˆã‚³ãƒ”ãƒƒãƒˆ / å¸½å­ã¨ã‚Šã‚²ãƒ¼ãƒ ï¼‰å®Ÿè£…ä»•æ§˜æ›¸ v3.0 FINAL

**ä½œæˆæ—¥**: 2025-12-23  
**å¯¾è±¡**: ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ç‰ˆï¼ˆFastAPI + WebSocketï¼‰  
**ç›¤é¢**: å®Ÿéš›ã®ç”»åƒãƒ™ãƒ¼ã‚¹ï¼ˆå¤–å‘¨ãƒªãƒ³ã‚° + ä¸­å¤®Xäº¤å·®è·¯ï¼‰  
**ãƒ«ãƒ¼ãƒ«**: P0ç¢ºå®šï¼ˆå…¬å¼å‚è€ƒURLæº–æ‹ ï¼‰

---

## 1. ç”¨èªé›†ï¼ˆGlossaryï¼‰

| ç”¨èª | è‹±èª | èª¬æ˜ |
|------|------|------|
| å¸½å­ | Hat | å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é§’ï¼ˆ1ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼6å€‹ï¼‰ |
| ã‚¹ã‚¿ãƒƒã‚¯ | Stack | åŒä¸€ãƒã‚¹ã«é‡ãªã£ãŸå¸½å­ã®æŸ |
| æ“ä½œä¸»ä½“ | Controller | ã‚¹ã‚¿ãƒƒã‚¯ã®æœ€ä¸Šä½ã®å¸½å­ã®è‰²ï¼ˆãã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‹•ã‹ã›ã‚‹ï¼‰ |
| æ•è™œ | Prisoners | ã‚¹ã‚¿ãƒƒã‚¯å†…ã§æ“ä½œä¸»ä½“ä»¥å¤–ã®å¸½å­ |
| BOX | Box/Start Zone | å„è‰²ã®åˆæœŸé…ç½®ã‚¨ãƒªã‚¢ï¼ˆç›¤é¢å¤–ã®å††å½¢ã‚¨ãƒªã‚¢ï¼‰ |
| ãƒ›ãƒ¼ãƒ ãƒã‚¹ | Home Square | å¤–å‘¨ã«ã‚ã‚‹å„è‰²ã®è‰²ä»˜ããƒã‚¹ï¼ˆå®‰å…¨åœ°å¸¯ï¼‰ |
| å®‰å…¨ãƒã‚¹ | Safe Square | æ•ç²ãŒç™ºç”Ÿã—ãªã„ãƒã‚¹ï¼ˆCENTER, HOMEç­‰ï¼‰ |
| å¤–å‘¨ | Outer Ring | ãƒ¡ã‚¤ãƒ³ã®å‘¨å›çµŒè·¯ï¼ˆ48ãƒã‚¹ï¼‰ |
| å†…å‘¨ | Inner Shortcut | ä¸­å¤®ã‚’æ¨ªæ–­ã™ã‚‹ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆçµŒè·¯ |
| åˆ†å²ç‚¹ | Junction | å¤–å‘¨ã¨å†…å‘¨ã®æ¥ç¶šãƒã‚¹ |

---

## 2. ã‚²ãƒ¼ãƒ æ¦‚è¦

### 2.1 åŸºæœ¬æƒ…å ±
- **ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°**: 4äººï¼ˆæ‹¡å¼µ: 2-6äººï¼‰
- **å¸½å­æ•°**: å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼6å€‹
- **ã‚µã‚¤ã‚³ãƒ­**: d6ï¼ˆ1-6ï¼‰
- **ç›¤é¢**: 
  - å¤–å‘¨48ãƒã‚¹ï¼ˆå‘¨å›ï¼‰
  - å†…å‘¨10ãƒã‚¹ï¼ˆåå­—ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼‰
  - BOX 4ç®‡æ‰€ï¼ˆå„è‰²ã®ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ï¼‰
  - åˆè¨ˆ68ãƒãƒ¼ãƒ‰

### 2.2 è‰²é…ç½®
| è‰² | ä½ç½® | BOXåº§æ¨™ | ãƒ›ãƒ¼ãƒ ãƒã‚¹ |
|----|------|---------|-----------|
| ğŸ”´ RED | å·¦ä¸Š | (-3.5, -3.5) | outer_18 |
| ğŸ”µ BLUE | å³ä¸Š | (3.5, -3.5) | outer_30 |
| ğŸŸ¡ YELLOW | å·¦ä¸‹ | (-3.5, 3.5) | outer_42 |
| ğŸŸ¢ GREEN | å³ä¸‹ | (3.5, 3.5) | outer_6 |

---

## 3. æ‰‹ç•ªãƒ•ãƒ­ãƒ¼ï¼ˆTurn Phasesï¼‰

### 3.1 ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»

```
WAITING â†’ ROLL â†’ SELECT_PIECE â†’ SELECT_PATH â†’ RESOLVE â†’ (ROLL or NEXT_TURN)
```

### 3.2 å„ãƒ•ã‚§ãƒ¼ã‚ºè©³ç´°

#### WAITING
- ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã®çŠ¶æ…‹
- å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ¥ç¶šã™ã‚‹ã¾ã§å¾…æ©Ÿ
- Botè£œå……ã‚¿ã‚¤ãƒãƒ¼èµ·å‹•ï¼ˆconfig.bot_fill_timeout_secï¼‰

#### ROLL
- ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹
- ã‚µãƒ¼ãƒãŒä¹±æ•°ç”Ÿæˆï¼ˆ1-6ï¼‰
- å‡ºç›®ã‚’å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é€šçŸ¥
- åˆæ³•æ‰‹ã‚’ç”Ÿæˆï¼ˆå¾Œè¿°ï¼‰
- **ç‰¹æ®Šãƒ«ãƒ¼ãƒ«**: 6ãŒå‡ºãŸå ´åˆ
  - `config.extra_roll_on_6 = true` â†’ ã‚‚ã†1å›æŒ¯ã‚Œã‚‹
  - `config.extra_roll_on_6 = false` â†’ é€šå¸¸é€šã‚Šé€²ã‚€

#### SELECT_PIECE
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‹•ã‹ã™ã‚¹ã‚¿ãƒƒã‚¯ã‚’é¸æŠ
- é¸æŠå¯èƒ½: 
  - BOXå†…ã®å¸½å­ï¼ˆã¾ã å‡ºã¦ã„ãªã„ï¼‰
  - ç›¤é¢ä¸Šã®è‡ªè‰²ãŒæœ€ä¸Šä½ã®ã‚¹ã‚¿ãƒƒã‚¯
- ã‚µãƒ¼ãƒãŒåˆæ³•åˆ¤å®š

#### SELECT_PATH
- åˆ†å²ãŒã‚ã‚‹å ´åˆã®ã¿ç™ºç”Ÿ
- ä¾‹: å¤–å‘¨ vs å†…å‘¨ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒçµŒè·¯ï¼ˆãƒãƒ¼ãƒ‰åˆ—ï¼‰ã‚’é¸æŠ
- ã‚µãƒ¼ãƒãŒçµŒè·¯ã®å¦¥å½“æ€§ã‚’æ¤œè¨¼

#### RESOLVE
- ç§»å‹•ã‚’å®Ÿè¡Œ
- å„ãƒã‚¹ã§ä»¥ä¸‹ã‚’åˆ¤å®š:
  1. æ•ç²åˆ¤å®šï¼ˆcapture_checkï¼‰
  2. å¥ªã„è¿”ã—åˆ¤å®šï¼ˆsteal_back_checkï¼‰
  3. å®‰å…¨åœ°å¸¯åˆ¤å®šï¼ˆsafe_zone_checkï¼‰
  4. ãƒ›ãƒ¼ãƒ åˆ°é”åˆ¤å®šï¼ˆhome_arrival_checkï¼‰
- çŠ¶æ…‹æ›´æ–°
- çµ‚äº†æ¡ä»¶ãƒã‚§ãƒƒã‚¯

#### NEXT_TURN or ROLL
- 6ãŒå‡ºã¦è¿½åŠ ãƒ­ãƒ¼ãƒ«ãŒæœ‰åŠ¹ â†’ ROLL ã¸æˆ»ã‚‹
- ãã‚Œä»¥å¤– â†’ æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ï¼ˆROLLï¼‰

---

## 4. åˆæœŸé…ç½®

### 4.1 ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚
- å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®6å€‹ã®å¸½å­ã¯å…¨ã¦ **BOX å†…** ã«é…ç½®
- ç›¤é¢ä¸Šã«ã¯ã¾ã å¸½å­ãªã—
- ã‚¿ãƒ¼ãƒ³é †: RED â†’ BLUE â†’ GREEN â†’ YELLOWï¼ˆæš«å®šã€configåŒ–å¯èƒ½ï¼‰

### 4.2 BOXã‹ã‚‰å‡ºã‚‹æ¡ä»¶
- è‡ªåˆ†ã®æ‰‹ç•ªã§ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹
- å‡ºç›®åˆ†ã ã‘BOXã‹ã‚‰å¤–å‘¨ã®æœ€åˆã®ãƒã‚¹ï¼ˆstart_red â†’ outer_0 ç­‰ï¼‰ã«é€²ã‚€
- BOXå†…ã«è¤‡æ•°å¸½å­ãŒã‚ã‚‹å ´åˆã€ã©ã‚Œã‚’å‡ºã™ã‹é¸æŠå¯èƒ½

---

## 5. ç§»å‹•ãƒ«ãƒ¼ãƒ«

### 5.1 åŸºæœ¬ç§»å‹•
- **1æ‰‹ç•ª1ã‚¹ã‚¿ãƒƒã‚¯**: 1å›ã®æ‰‹ç•ªã§å‹•ã‹ã›ã‚‹ã®ã¯1ã¤ã®ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆæ•è™œå«ã‚€ï¼‰ã®ã¿
- **å‡ºç›®åˆ†ç§»å‹•**: d6ã®å‡ºç›®åˆ†ã ã‘ãƒãƒ¼ãƒ‰ã‚’é€²ã‚€ï¼ˆä¾‹: 3ãŒå‡ºãŸã‚‰3ãƒãƒ¼ãƒ‰ï¼‰
- **æ–¹å‘**: æ™‚è¨ˆå›ã‚Šï¼ˆouter_0 â†’ outer_1 â†’ ... â†’ outer_47 â†’ outer_0ï¼‰
- **å¾Œé€€**: ä¸å¯ï¼ˆæš«å®š: `config.allow_backward = false`ï¼‰

### 5.2 åˆ†å²ï¼ˆJunctionï¼‰
å¤–å‘¨ã®ä»¥ä¸‹ã®ãƒã‚¹ã§å†…å‘¨ã¸åˆ†å²å¯èƒ½:
- `outer_7` (åŒ—) â†’ `inner_n_0`
- `outer_19` (æ±) â†’ `inner_e_0`
- `outer_31` (å—) â†’ `inner_s_0`
- `outer_43` (è¥¿) â†’ `inner_w_0`

**åˆ†å²é¸æŠ**:
- å‡ºç›®ã®é€”ä¸­ã§åˆ†å²ç‚¹ã«åˆ°é”ã—ãŸã‚‰ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé¸æŠ
- å¤–å‘¨ç¶šè¡Œ or å†…å‘¨ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
- æ®‹ã‚Šç§»å‹•ç‚¹ã‚’é¸ã‚“ã çµŒè·¯ã§æ¶ˆè²»

### 5.3 ã´ã£ãŸã‚Šä¸è¦
- ãƒ›ãƒ¼ãƒ ãƒã‚¹ã‚„ä»»æ„ã®ãƒã‚¹ã«ã€Œã´ã£ãŸã‚Šã€æ­¢ã¾ã‚‹å¿…è¦ãªã—ï¼ˆæš«å®š: `config.home_exact_required = false`ï¼‰
- å‡ºç›®ãŒä½™ã£ãŸå ´åˆã®å‡¦ç†ã¯å¾Œè¿°

### 5.4 ä½™å‰°ç§»å‹•ï¼ˆOvershootï¼‰
å‡ºç›®ãŒä½™ã‚‹å ´åˆã®å‡¦ç†ï¼ˆæš«å®šè¨­å®šï¼‰:

| ãƒ¢ãƒ¼ãƒ‰ | èª¬æ˜ | configå€¤ |
|--------|------|----------|
| DISCARD | ä½™å‰°ã¯æ¨ã¦ã‚‹ | `home_overshoot_mode = "discard"` |
| LOOP | å¤–å‘¨ã‚’å‘¨å›ã—ç¶šã‘ã‚‹ | `home_overshoot_mode = "loop"` |
| STOP_AT_HOME | ãƒ›ãƒ¼ãƒ ãƒã‚¹ã§å¼·åˆ¶åœæ­¢ | `home_overshoot_mode = "stop_at_home"` |

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**: `DISCARD`ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰

---

## 6. æ•ç²ãƒ«ãƒ¼ãƒ«ï¼ˆCaptureï¼‰

### 6.1 æ•ç²æ¡ä»¶ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
ä»¥ä¸‹ã®**å…¨ã¦**ã‚’æº€ãŸã™ã¨æ•ç²ç™ºç”Ÿ:
1. ç§»å‹•å…ˆã®ãƒã‚¹ã«**ç›¸æ‰‹è‰²ã®å¸½å­ï¼ˆã‚¹ã‚¿ãƒƒã‚¯ï¼‰**ãŒã„ã‚‹
2. ãã®ãƒã‚¹ãŒ**å®‰å…¨ãƒã‚¹ã§ã¯ãªã„**ï¼ˆ`SAFE`ã‚¿ã‚°ãªã—ï¼‰
3. `config.capture_on_pass = false` ã®å ´åˆã€**åˆ°é”æ™‚ã®ã¿**ï¼ˆé€šéã§ã¯æ•ç²ã—ãªã„ï¼‰

### 6.2 æ•ç²ã®çµæœ
```
ç§»å‹•å‰: ãƒã‚¹Aã« [ç›¸æ‰‹å¸½å­a, ç›¸æ‰‹å¸½å­b] ã®ã‚¹ã‚¿ãƒƒã‚¯
ç§»å‹•å¾Œ: [ç›¸æ‰‹å¸½å­a, ç›¸æ‰‹å¸½å­b, è‡ªåˆ†å¸½å­] ã®ã‚¹ã‚¿ãƒƒã‚¯
        â†’ æ“ä½œä¸»ä½“ãŒã€Œè‡ªåˆ†ã€ã«ãªã‚‹
```

- è‡ªåˆ†ã®å¸½å­ãŒæœ€ä¸Šä½ã«ä¹—ã‚‹
- ç›¸æ‰‹ã®ã‚¹ã‚¿ãƒƒã‚¯å…¨ä½“ãŒæ•è™œã«ãªã‚‹
- æ•è™œã‚’é€£ã‚Œã¦ç§»å‹•å¯èƒ½

### 6.3 åŒè‰²ã®æ‰±ã„
- åŒè‰²ã‚¹ã‚¿ãƒƒã‚¯ãŒã„ã‚‹ãƒã‚¹ã«åˆ°é”ã—ãŸå ´åˆã€**æ•ç²ã§ã¯ãªãçµ±åˆ**
- ã‚¹ã‚¿ãƒƒã‚¯ãŒ1ã¤ã«çµ±åˆã•ã‚Œã€ç§»å‹•ç¶šè¡Œ

### 6.4 å®‰å…¨ãƒã‚¹ã§ã®æ•ç²æŠ‘æ­¢
ä»¥ä¸‹ã®ãƒã‚¹ã§ã¯æ•ç²ãŒ**ç™ºç”Ÿã—ãªã„**ï¼ˆ`config.safe_blocks_capture = true`ï¼‰:
- `tags: ["SAFE"]` ã‚’æŒã¤ãƒã‚¹
  - outer_6, outer_18, outer_30, outer_42ï¼ˆå„è‰²ãƒ›ãƒ¼ãƒ ãƒã‚¹ï¼‰
  - inner_centerï¼ˆä¸­å¤®ï¼‰
- `tags: ["BOX"]` ã‚’æŒã¤ãƒã‚¹ï¼ˆå„è‰²ã®ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ï¼‰

### 6.5 é€šéæ•ç²ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
`config.capture_on_pass = true` ã®å ´åˆ:
- å‡ºç›®ã®é€”ä¸­ã§é€šéã—ãŸãƒã‚¹ã§ã‚‚æ•ç²ç™ºç”Ÿ
- ä¾‹: å‡ºç›®4ã§ã€2ãƒã‚¹ç›®ã«ç›¸æ‰‹ãŒã„ãŸã‚‰æ•ç²ã—ã¦æ®‹ã‚Š2ãƒã‚¹é€²ã‚€

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**: `false`ï¼ˆåˆ°é”ã®ã¿ï¼‰

---

## 7. å¥ªã„è¿”ã—ï¼ˆSteal Backï¼‰

### 7.1 å¥ªã„è¿”ã—æ¡ä»¶
ä»¥ä¸‹ã‚’æº€ãŸã™ã¨å¥ªã„è¿”ã—ç™ºç”Ÿï¼ˆ`config.steal_back_enabled = true`ï¼‰:
1. ç§»å‹•å…ˆã®ãƒã‚¹ã«**ç›¸æ‰‹è‰²ãŒæ“ä½œã™ã‚‹ã‚¹ã‚¿ãƒƒã‚¯**ãŒã„ã‚‹
2. ãã®ã‚¹ã‚¿ãƒƒã‚¯ã®**å†…éƒ¨ã«è‡ªè‰²ã®å¸½å­ãŒæ•è™œã¨ã—ã¦å«ã¾ã‚Œã¦ã„ã‚‹**
3. ãã®ãƒã‚¹ãŒå®‰å…¨ãƒã‚¹ã§ãªã„ï¼ˆæš«å®šï¼‰

### 7.2 å¥ªã„è¿”ã—ã®çµæœ
```
ç§»å‹•å‰: ç›¸æ‰‹ã‚¹ã‚¿ãƒƒã‚¯ [è‡ªåˆ†å¸½å­a(æ•è™œ), ç›¸æ‰‹å¸½å­b, ç›¸æ‰‹å¸½å­c(æœ€ä¸Šä½)]
ç§»å‹•å¾Œ: [è‡ªåˆ†å¸½å­a, ç›¸æ‰‹å¸½å­b, ç›¸æ‰‹å¸½å­c, è‡ªåˆ†å¸½å­d(ç§»å‹•ã—ãŸå¸½å­)]
        â†’ æ“ä½œä¸»ä½“ãŒã€Œè‡ªåˆ†ã€ã«å¤‰ã‚ã‚‹
```

- è‡ªåˆ†ã®å¸½å­ãŒæœ€ä¸Šä½ã«ä¹—ã‚‹
- æ•è™œã ã£ãŸè‡ªè‰²å¸½å­ã‚’ã€Œè§£æ”¾ã€ã—ãŸã“ã¨ã«ãªã‚‹
- ç›¸æ‰‹å¸½å­ãŒä»Šåº¦ã¯æ•è™œã«ãªã‚‹

### 7.3 å¥ªã„è¿”ã—ã¨æ•ç²ã®å„ªå…ˆåº¦
- ä¸¡æ–¹ã®æ¡ä»¶ã‚’æº€ãŸã™å ´åˆã€**å¥ªã„è¿”ã—ã‚’å„ªå…ˆ**ï¼ˆæš«å®šï¼‰
- å®Ÿè£…: `resolve_capture_or_steal_back()` ã§åˆ¤å®š

---

## 8. ãƒ›ãƒ¼ãƒ ãƒã‚¹ã¨ã‚´ãƒ¼ãƒ«

### 8.1 ãƒ›ãƒ¼ãƒ ãƒã‚¹ã®å½¹å‰²
å¤–å‘¨ã®è‰²ä»˜ããƒã‚¹ï¼ˆouter_6/18/30/42ï¼‰ã¯å„è‰²ã®**å®‰å…¨åœ°å¸¯**:
- ãã®ãƒã‚¹ã«ã„ã‚‹é–“ã¯æ•ç²ã•ã‚Œãªã„ï¼ˆ`SAFE`ã‚¿ã‚°ï¼‰
- è‡ªè‰²ã®ãƒ›ãƒ¼ãƒ ãƒã‚¹ã«åˆ°é”ã™ã‚‹ã¨ã€æ•è™œã‚’ã€Œç¢ºä¿ï¼ˆbankï¼‰ã€ã§ãã‚‹ï¼ˆæš«å®šï¼‰

### 8.2 æ•è™œã®ç¢ºä¿ï¼ˆBankingï¼‰
**æ¡ˆA: å³åº§ã«ç¢ºä¿**ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæš«å®šï¼‰
- ãƒ›ãƒ¼ãƒ ãƒã‚¹ã«åˆ°é”ã—ãŸæ™‚ç‚¹ã§ã€é€£ã‚Œã¦ã„ãŸæ•è™œã‚’**å¾—ç‚¹åŒ–**
- æ•è™œã¯ã‚²ãƒ¼ãƒ ã‹ã‚‰é™¤å¤–ï¼ˆç›¤é¢ã«æˆ»ã‚‰ãªã„ï¼‰
- ã‚¹ã‚³ã‚¢: `player.score += æ•è™œã®æ•°`

**æ¡ˆB: æ‰‹å‹•ç¢ºä¿**
- ãƒ›ãƒ¼ãƒ ãƒã‚¹ã«åˆ°é”ã—ã¦ã‚‚ã€æ¬¡ã®æ‰‹ç•ªã§ã€Œç¢ºä¿ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€ã‚’é¸ã¶å¿…è¦ãŒã‚ã‚‹
- ç¢ºä¿ã—ãªã„å ´åˆã€æ•è™œã‚’é€£ã‚Œã¦å†å‡ºç™º

**å®Ÿè£…**: ä¸¡æ–¹å¯¾å¿œå¯èƒ½ã«ã—ã€`config.auto_bank_on_home = true/false`

### 8.3 ç¢ºä¿ã—ãŸæ•è™œã®æ‰±ã„
- ç¢ºä¿å¾Œã€æ•è™œã¯**å…ƒã®è‰²ã®BOXã«æˆ»ã‚‹**ï¼ˆæ¡ˆAï¼‰
- ã¾ãŸã¯**ã‚²ãƒ¼ãƒ ã‹ã‚‰é™¤å¤–**ï¼ˆæ¡ˆBï¼‰
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ã‚²ãƒ¼ãƒ ã‹ã‚‰é™¤å¤–ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰

### 8.4 è‡ªè‰²å¸½å­ã®å¾©æ´»
è‡ªåˆ†ã®å¸½å­ãŒæ•è™œã«ã•ã‚ŒãŸå ´åˆ:
- å¥ªã„è¿”ã—ã§è§£æ”¾ã•ã‚Œã‚‹
- ã¾ãŸã¯æ•µãŒãƒ›ãƒ¼ãƒ ãƒã‚¹ã§ç¢ºä¿ã—ã¦é™¤å¤–ã•ã‚Œã‚‹
- é™¤å¤–ã•ã‚ŒãŸå ´åˆã€**å¾©æ´»ã—ãªã„**ï¼ˆæš«å®šï¼‰

å°†æ¥æ‹¡å¼µ: `config.allow_respawn = true` ã§å¾©æ´»ãƒ«ãƒ¼ãƒ«è¿½åŠ 

---

## 9. çµ‚äº†æ¡ä»¶ãƒ»å‹åˆ©åˆ¤å®š

### 9.1 çµ‚äº†æ¡ä»¶ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼‰

#### ãƒ¢ãƒ¼ãƒ‰A: å…¨æ»…åˆ¤å®šï¼ˆEliminationï¼‰
- ç›¤é¢ä¸Šã«**1è‰²ã—ã‹æ®‹ã£ã¦ã„ãªã„**çŠ¶æ…‹ã«ãªã£ãŸã‚‰çµ‚äº†
- é™¤å¤–åˆ¤å®š: ã‚ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¨å¸½å­ãŒ
  - BOXå†…ï¼ˆå‡ºã¦ã„ãªã„ï¼‰+ æ•è™œï¼ˆç¢ºä¿æ¸ˆï¼‰ = 6å€‹

#### ãƒ¢ãƒ¼ãƒ‰B: ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ï¼ˆRound Limitï¼‰
- è¨­å®šã—ãŸãƒ©ã‚¦ãƒ³ãƒ‰æ•°ï¼ˆä¾‹: å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼20æ‰‹ç•ªï¼‰ã§çµ‚äº†
- ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ã§å¾—ç‚¹æ¯”è¼ƒ

#### ãƒ¢ãƒ¼ãƒ‰C: ç›®æ¨™å¾—ç‚¹ï¼ˆScore Targetï¼‰
- å…ˆã«è¨­å®šã‚¹ã‚³ã‚¢ï¼ˆä¾‹: 10ç‚¹ï¼‰ã«åˆ°é”ã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‹åˆ©

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**: ãƒ¢ãƒ¼ãƒ‰Aï¼ˆå…¨æ»…åˆ¤å®šï¼‰ã€`config.win_mode = "elimination"`

### 9.2 å‹åˆ©åˆ¤å®š

#### æ”»å‹¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆOffensiveï¼‰
- ç¢ºä¿ã—ãŸæ•è™œæ•°ãŒ**æœ€å¤šã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼**ãŒå‹åˆ©
- `player.score` ã§æ¯”è¼ƒ

#### å®ˆå‹¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆDefensiveï¼‰
- æœ€å¾Œã¾ã§ç›¤é¢ã«å¸½å­ãŒ**æ®‹ã£ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼**ãŒå‹åˆ©
- å…¨æ»…åˆ¤å®šã¨çµ„ã¿åˆã‚ã›

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**: æ”»å‹¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆ`config.win_mode = "offensive"`ï¼‰

### 9.3 å¼•ãåˆ†ã‘å‡¦ç†
åŒç‚¹ã®å ´åˆ:
- ã‚¿ã‚¤ãƒ–ãƒ¬ãƒ¼ã‚¯1: ç›¤é¢ã«æ®‹ã£ã¦ã„ã‚‹è‡ªè‰²å¸½å­ã®æ•°
- ã‚¿ã‚¤ãƒ–ãƒ¬ãƒ¼ã‚¯2: å…ˆã«åˆ°é”ã—ãŸæ–¹ï¼ˆã‚¿ãƒ¼ãƒ³æ•°ï¼‰
- ãã‚Œã§ã‚‚åŒã˜ â†’ å¼•ãåˆ†ã‘ï¼ˆ`winner = null`ï¼‰

---

## 10. è¨­å®šé …ç›®ï¼ˆGameConfigï¼‰

å®Ÿè£…ã§åˆ‡æ›¿å¯èƒ½ãªå…¨è¨­å®š:

| è¨­å®šå | å‹ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|--------|-----|-----------|------|
| `max_players` | int | 4 | ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•° |
| `hats_per_player` | int | 6 | å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¸½å­æ•° |
| `extra_roll_on_6` | bool | true | 6ãŒå‡ºãŸã‚‰è¿½åŠ ãƒ­ãƒ¼ãƒ« |
| `capture_on_pass` | bool | false | é€šéãƒã‚¹ã§æ•ç²ã™ã‚‹ã‹ |
| `steal_back_enabled` | bool | true | å¥ªã„è¿”ã—æœ‰åŠ¹ |
| `safe_blocks_capture` | bool | true | SAFEãƒã‚¹ã§æ•ç²æŠ‘æ­¢ |
| `home_exact_required` | bool | false | ãƒ›ãƒ¼ãƒ ã«ã´ã£ãŸã‚Šè¦å¦ |
| `home_overshoot_mode` | enum | "discard" | ä½™å‰°ç§»å‹•ã®æ‰±ã„ |
| `auto_bank_on_home` | bool | true | ãƒ›ãƒ¼ãƒ åˆ°é”ã§è‡ªå‹•ç¢ºä¿ |
| `win_mode` | enum | "offensive" | å‹åˆ©ãƒ¢ãƒ¼ãƒ‰ |
| `bot_fill_timeout_sec` | int | 30 | Botè£œå……å¾…ã¡æ™‚é–“ |
| `allow_backward` | bool | false | å¾Œé€€ç§»å‹•ã®å¯å¦ |
| `allow_respawn` | bool | false | é™¤å¤–å¸½å­ã®å¾©æ´» |

---

## 11. å…·ä½“ä¾‹ï¼ˆTest Casesï¼‰

### ä¾‹1: åŸºæœ¬ç§»å‹•
- **çŠ¶æ…‹**: èµ¤ã®å¸½å­1ãŒBOXå†…ã€ç›¤é¢ã¯ç©º
- **å‡ºç›®**: 3
- **é¸æŠ**: å¸½å­1ã‚’BOXã‹ã‚‰å‡ºã™
- **æœŸå¾…çµæœ**: å¸½å­1ãŒ `outer_0` ã‹ã‚‰3ãƒã‚¹é€²ã‚“ã§ `outer_3` ã«åˆ°é”
- **ã‚¹ã‚¿ãƒƒã‚¯**: `[Red Hat 1]` at outer_3

### ä¾‹2: æ•ç²ï¼ˆå˜ä½“ï¼‰
- **çŠ¶æ…‹**: 
  - é’ã®å¸½å­AãŒ `outer_10` ã«ã„ã‚‹
  - èµ¤ã®å¸½å­BãŒ `outer_7` ã«ã„ã‚‹
- **å‡ºç›®**: 3ï¼ˆèµ¤ã®æ‰‹ç•ªï¼‰
- **é¸æŠ**: å¸½å­Bã‚’å‹•ã‹ã™
- **çµŒè·¯**: outer_7 â†’ outer_8 â†’ outer_9 â†’ outer_10
- **æœŸå¾…çµæœ**: 
  - `outer_10` ã«åˆ°é”
  - é’Aã‚’æ•ç²
  - ã‚¹ã‚¿ãƒƒã‚¯: `[Blue A, Red B]` at outer_10
  - æ“ä½œä¸»ä½“: Red

### ä¾‹3: ã‚¹ã‚¿ãƒƒã‚¯ç§»å‹•
- **çŠ¶æ…‹**: ã‚¹ã‚¿ãƒƒã‚¯ `[Blue A, Red B]` ãŒ `outer_10` ã«ã„ã‚‹ï¼ˆRedãŒæ“ä½œä¸»ä½“ï¼‰
- **å‡ºç›®**: 5
- **é¸æŠ**: ã“ã®ã‚¹ã‚¿ãƒƒã‚¯ã‚’å‹•ã‹ã™
- **æœŸå¾…çµæœ**: ã‚¹ã‚¿ãƒƒã‚¯å…¨ä½“ãŒ `outer_15` ã«ç§»å‹•

### ä¾‹4: å¥ªã„è¿”ã—
- **çŠ¶æ…‹**: 
  - ã‚¹ã‚¿ãƒƒã‚¯ `[Red A(æ•è™œ), Blue B]` ãŒ `outer_20` ã«ã„ã‚‹ï¼ˆBlueãŒæ“ä½œä¸»ä½“ï¼‰
  - Red CãŒ `outer_17` ã«ã„ã‚‹
- **å‡ºç›®**: 3ï¼ˆèµ¤ã®æ‰‹ç•ªï¼‰
- **é¸æŠ**: Red Cã‚’å‹•ã‹ã™
- **æœŸå¾…çµæœ**: 
  - `outer_20` ã«åˆ°é”
  - Red Aã‚’è§£æ”¾
  - ã‚¹ã‚¿ãƒƒã‚¯: `[Red A, Blue B, Red C]` at outer_20
  - æ“ä½œä¸»ä½“: Red

### ä¾‹5: å®‰å…¨ãƒã‚¹ã§ã®æ•ç²æŠ‘æ­¢
- **çŠ¶æ…‹**: 
  - Blue AãŒ `outer_6`ï¼ˆGreenã®ãƒ›ãƒ¼ãƒ ãƒã‚¹ã€SAFEï¼‰ã«ã„ã‚‹
  - Red BãŒ `outer_3` ã«ã„ã‚‹
- **å‡ºç›®**: 3
- **æœŸå¾…çµæœ**: 
  - `outer_6` ã«åˆ°é”
  - SAFEã‚¿ã‚°ã«ã‚ˆã‚Šæ•ç²**ã—ãªã„**
  - ã‚¹ã‚¿ãƒƒã‚¯: `[Blue A]` ã¨ `[Red B]` ãŒåŒã˜ãƒã‚¹ã«å…±å­˜ï¼ˆåˆ¥ã‚¹ã‚¿ãƒƒã‚¯ï¼‰

### ä¾‹6: ãƒ›ãƒ¼ãƒ åˆ°é”ã¨ç¢ºä¿
- **çŠ¶æ…‹**: 
  - ã‚¹ã‚¿ãƒƒã‚¯ `[Blue A(æ•è™œ), Blue B(æ•è™œ), Red C]` ãŒ `outer_15` ã«ã„ã‚‹
  - Redã®ãƒ›ãƒ¼ãƒ ãƒã‚¹ã¯ `outer_18`
- **å‡ºç›®**: 3
- **æœŸå¾…çµæœ**: 
  - `outer_18` ã«åˆ°é”
  - `auto_bank_on_home = true` ã«ã‚ˆã‚Šæ•è™œ2å€‹ã‚’ç¢ºä¿
  - Red ã® score += 2
  - Blue A, B ã¯ã‚²ãƒ¼ãƒ ã‹ã‚‰é™¤å¤–
  - `outer_18` ã« `[Red C]` ã®ã¿æ®‹ã‚‹

### ä¾‹7: åˆ†å²é¸æŠï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼‰
- **çŠ¶æ…‹**: Red AãŒ `outer_5` ã«ã„ã‚‹
- **å‡ºç›®**: 4
- **é¸æŠ**: ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’é¸ã¶
- **çµŒè·¯**: outer_5 â†’ outer_6 â†’ outer_7 â†’ inner_n_0 â†’ inner_n_1
- **æœŸå¾…çµæœ**: `inner_n_1` ã«åˆ°é”ï¼ˆå†…å‘¨ã«å…¥ã‚‹ï¼‰

### ä¾‹8: 6ã§è¿½åŠ ãƒ­ãƒ¼ãƒ«
- **çŠ¶æ…‹**: `extra_roll_on_6 = true`
- **å‡ºç›®**: 6
- **é¸æŠ**: Red Aã‚’6ãƒã‚¹é€²ã‚ã‚‹
- **æœŸå¾…çµæœ**: ç§»å‹•å¾Œã€ã‚‚ã†ä¸€åº¦ROLLãƒ•ã‚§ãƒ¼ã‚ºã«ãªã‚‹ï¼ˆåŒã˜ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰

### ä¾‹9: åŒè‰²çµ±åˆ
- **çŠ¶æ…‹**: 
  - Red AãŒ `outer_10` ã«ã„ã‚‹
  - Red BãŒ `outer_8` ã«ã„ã‚‹
- **å‡ºç›®**: 2ï¼ˆRedã®æ‰‹ç•ªã€Red Bã‚’å‹•ã‹ã™ï¼‰
- **æœŸå¾…çµæœ**: 
  - `outer_10` ã«åˆ°é”
  - æ•ç²ã§ã¯ãªãçµ±åˆ
  - ã‚¹ã‚¿ãƒƒã‚¯: `[Red A, Red B]` at outer_10

### ä¾‹10: çµ‚äº†æ¡ä»¶ï¼ˆå…¨æ»…ï¼‰
- **çŠ¶æ…‹**: 
  - Redã®å…¨6å¸½å­ãŒé™¤å¤–æ¸ˆã¿
  - Blueã®å…¨6å¸½å­ãŒé™¤å¤–æ¸ˆã¿
  - Yellowã®å…¨6å¸½å­ãŒé™¤å¤–æ¸ˆã¿
  - Greenã®å¸½å­ãŒç›¤é¢ã«æ®‹ã£ã¦ã„ã‚‹
- **æœŸå¾…çµæœ**: 
  - ã‚²ãƒ¼ãƒ çµ‚äº†
  - å‹è€…: Greenï¼ˆæœ€å¾Œã¾ã§æ®‹ã£ãŸï¼‰

---

## 12. Gap Listï¼ˆä¸æ˜ç‚¹ã¨å¯¾å¿œæ–¹é‡ï¼‰

### P0ï¼ˆå®Ÿè£…ã«å¿…é ˆï¼‰

#### P0-1: å†…å‘¨ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã®è©³ç´°ãƒ«ãƒ¼ãƒ«
- **ä¸æ˜ç‚¹**: å†…å‘¨ã‚’é€šã‚‹éš›ã€å¤–å‘¨ã‚ˆã‚Šä½•ãƒã‚¹çŸ­ç¸®ï¼Ÿ
- **Aæ¡ˆ**: å†…å‘¨ã¯2ãƒã‚¹ï¼ˆjunction â†’ centerï¼‰ã€å¤–å‘¨ã¯6ãƒã‚¹ç›¸å½“ â†’ 4ãƒã‚¹çŸ­ç¸®
- **Bæ¡ˆ**: æ­£ç¢ºãªãƒã‚¹æ•°ã‚’ãƒ«ãƒ¼ãƒ«ã§ç¢ºå®š
- **æš«å®šå¯¾å¿œ**: ç”»åƒã‹ã‚‰æ¨æ¸¬ã—ãŸãƒãƒ¼ãƒ‰é…ç½®ã‚’æ¡ç”¨ï¼ˆ2ãƒã‚¹çŸ­ç¸®ï¼‰
- **è¨­å®š**: ãªã—ï¼ˆç›¤é¢å›ºå®šï¼‰

#### P0-2: BOXã‹ã‚‰å‡ºã‚‹éš›ã®åˆæœŸä½ç½®
- **ä¸æ˜ç‚¹**: BOXã‹ã‚‰æœ€åˆã«å‡ºã‚‹ãƒã‚¹ã¯ã©ã“ï¼Ÿ
- **Aæ¡ˆ**: start_red â†’ outer_0ï¼ˆç›´æ¥æ¥ç¶šï¼‰
- **Bæ¡ˆ**: BOXã‹ã‚‰å‡ºã‚‹ã«ã¯ç‰¹å®šå‡ºç›®ãŒå¿…è¦ï¼ˆä¾‹: 6ï¼‰
- **æš«å®šå¯¾å¿œ**: Aæ¡ˆæ¡ç”¨ï¼ˆä»»æ„ã®å‡ºç›®ã§å‡ºã‚‰ã‚Œã‚‹ï¼‰
- **è¨­å®š**: `config.box_exit_requires_six = false`

#### P0-3: è‰²ãƒã‚¹ï¼ˆouter_6ç­‰ï¼‰ã®æ­£ç¢ºãªå½¹å‰²
- **ä¸æ˜ç‚¹**: ãƒ›ãƒ¼ãƒ ãƒã‚¹ã¯ã€Œå®‰å…¨åœ°å¸¯ã®ã¿ã€ã‹ã€Œå¾—ç‚¹åŒ–åœ°ç‚¹ã€ã‹
- **Aæ¡ˆ**: å®‰å…¨åœ°å¸¯ã®ã¿ï¼ˆæ•ç²ã•ã‚Œãªã„ï¼‰
- **Bæ¡ˆ**: åˆ°é”ã§æ•è™œã‚’ç¢ºä¿ã—ã¦å¾—ç‚¹åŒ–
- **æš«å®šå¯¾å¿œ**: Bæ¡ˆæ¡ç”¨ï¼ˆ`auto_bank_on_home = true`ï¼‰
- **è¨­å®š**: `config.home_function = "bank"` or `"safe_only"`

### P1ï¼ˆå‹•ä½œã«å½±éŸ¿ã™ã‚‹ãŒå¾Œå›ã—å¯ï¼‰

#### P1-1: è¤‡æ•°å¸½å­ã®åŒæ™‚ç§»å‹•
- **ä¸æ˜ç‚¹**: 1æ‰‹ç•ªã§è¤‡æ•°ã®ã‚¹ã‚¿ãƒƒã‚¯ã‚’å‹•ã‹ã›ã‚‹ã‹ï¼Ÿ
- **Aæ¡ˆ**: 1ã‚¹ã‚¿ãƒƒã‚¯ã®ã¿
- **Bæ¡ˆ**: å‡ºç›®ã‚’åˆ†å‰²ã—ã¦è¤‡æ•°ã«å‰²ã‚ŠæŒ¯ã‚Œã‚‹
- **æš«å®šå¯¾å¿œ**: Aæ¡ˆï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰
- **è¨­å®š**: `config.allow_split_move = false`

#### P1-2: ã‚¿ãƒ¼ãƒ³é †ã®æ±ºå®šæ–¹æ³•
- **ä¸æ˜ç‚¹**: æœ€åˆã®ã‚¿ãƒ¼ãƒ³é †ã¯ï¼Ÿ
- **Aæ¡ˆ**: å›ºå®šé †ï¼ˆRED â†’ BLUE â†’ GREEN â†’ YELLOWï¼‰
- **Bæ¡ˆ**: ãƒ©ãƒ³ãƒ€ãƒ 
- **Cæ¡ˆ**: å…¨å“¡ãŒæŒ¯ã£ã¦æœ€å¤§å€¤ã‹ã‚‰
- **æš«å®šå¯¾å¿œ**: Aæ¡ˆ
- **è¨­å®š**: `config.turn_order_method = "fixed"/"random"/"dice"`

#### P1-3: Bot ã®æ€è€ƒãƒ¬ãƒ™ãƒ«
- **ä¸æ˜ç‚¹**: Bot ã®æˆ¦ç•¥ã‚’ã©ã“ã¾ã§ä½œã‚Šè¾¼ã‚€ã‹
- **Aæ¡ˆ**: ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆåˆæ³•æ‰‹ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼‰
- **Bæ¡ˆ**: ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼ˆæ•ç²å„ªå…ˆã€å®‰å…¨å„ªå…ˆï¼‰
- **Cæ¡ˆ**: AIï¼ˆå¼·åŒ–å­¦ç¿’ç­‰ï¼‰
- **æš«å®šå¯¾å¿œ**: Bæ¡ˆï¼ˆãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼‰
- **è¨­å®š**: `config.bot_strategy = "random"/"heuristic"/"ai"`

### P2ï¼ˆé‹ç”¨ãƒ»UIï¼‰

#### P2-1: ç›¤é¢ã®å›è»¢
- **ä¸æ˜ç‚¹**: å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰è¦‹ã¦è‡ªåˆ†ãŒæ‰‹å‰ã«ãªã‚‹ã‚ˆã†å›è»¢ï¼Ÿ
- **å¯¾å¿œ**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å®Ÿè£…ï¼ˆåº§æ¨™å¤‰æ›ï¼‰

#### P2-2: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
- **ä¸æ˜ç‚¹**: é§’ç§»å‹•ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€Ÿåº¦
- **å¯¾å¿œ**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šï¼ˆUIå±¤ï¼‰

#### P2-3: ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
- **ä¸æ˜ç‚¹**: ã‚²ãƒ¼ãƒ ä¸­ã®ãƒãƒ£ãƒƒãƒˆæœ‰ç„¡
- **å¯¾å¿œ**: WebSocketã§å®Ÿè£…å¯èƒ½ï¼ˆå„ªå…ˆåº¦ä½ï¼‰

---

## 13. å®Ÿè£…ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 13.1 Backendï¼ˆPython/FastAPIï¼‰

#### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
```
trap_the_cap/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py              # FastAPI app, WebSocket endpoint
â”‚   â”œâ”€â”€ models.py            # Pydantic models (GameState, Config, etc.)
â”‚   â”œâ”€â”€ engine.py            # ãƒ«ãƒ¼ãƒ«ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆç´”ç²‹é–¢æ•°ï¼‰
â”‚   â”œâ”€â”€ connection.py        # ConnectionManager (Redis + WS)
â”‚   â”œâ”€â”€ bot.py               # Bot AI
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â””â”€â”€ board_4p_accurate.json  # ç›¤é¢ãƒ‡ãƒ¼ã‚¿
â”‚   â””â”€â”€ tests/
â”‚       â”œâ”€â”€ test_engine.py   # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
â”‚       â””â”€â”€ test_integration.py
â”œâ”€â”€ static/                  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ game.js
â”‚   â””â”€â”€ style.css
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ render.yaml              # Render Blueprint
â””â”€â”€ README.md
```

#### çŠ¶æ…‹ãƒ¢ãƒ‡ãƒ«ï¼ˆmodels.pyï¼‰
```python
class Node(BaseModel):
    id: str
    x: float
    y: float
    neighbors: List[str]
    tags: List[str]
    home_color: Optional[str]

class Hat(BaseModel):
    id: str
    color: PlayerColor
    owner: PlayerColor

class Stack(BaseModel):
    id: str
    node_id: str
    pieces: List[Hat]
    
    @property
    def controller(self) -> PlayerColor:
        return self.pieces[-1].color

class Player(BaseModel):
    id: str
    name: str
    color: PlayerColor
    is_bot: bool
    score: int
    connected: bool

class GameConfig(BaseModel):
    max_players: int = 4
    hats_per_player: int = 6
    extra_roll_on_6: bool = True
    capture_on_pass: bool = False
    steal_back_enabled: bool = True
    # ... ä»–ã®è¨­å®š

class GameState(BaseModel):
    room_id: str
    config: GameConfig
    nodes: Dict[str, Node]
    stacks: Dict[str, Stack]
    players: Dict[str, Player]
    turn_order: List[str]
    current_turn_index: int
    phase: GamePhase
    dice_value: Optional[int]
    legal_moves: List[LegalMove]
    logs: List[ActionLog]
    winner: Optional[str]
```

#### ãƒ«ãƒ¼ãƒ«ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆengine.pyï¼‰
ç´”ç²‹é–¢æ•°ã§å®Ÿè£…ã—ã€ãƒ†ã‚¹ãƒˆå¯èƒ½ã«ã™ã‚‹:
```python
def init_game(room_id: str, board_data: dict, config: GameConfig) -> GameState:
    """ã‚²ãƒ¼ãƒ åˆæœŸåŒ–"""

def add_player(state: GameState, player_id: str, name: str, is_bot: bool) -> GameState:
    """ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ """

def roll_dice(state: GameState, seed: Optional[int] = None) -> Tuple[GameState, int]:
    """ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹ï¼ˆä¹±æ•°ç”Ÿæˆï¼‰"""

def generate_legal_moves(state: GameState) -> List[LegalMove]:
    """ç¾åœ¨ã®çŠ¶æ…‹ã‹ã‚‰åˆæ³•æ‰‹ã‚’åˆ—æŒ™"""

def apply_move(state: GameState, move: LegalMove) -> GameState:
    """æ‰‹ã‚’é©ç”¨ï¼ˆimmutableæ›´æ–°ï¼‰"""

def check_game_over(state: GameState) -> Optional[str]:
    """çµ‚äº†åˆ¤å®šã€å‹è€…IDã‚’è¿”ã™"""

def resolve_capture(state: GameState, stack: Stack, target_node: str) -> GameState:
    """æ•ç²å‡¦ç†"""

def resolve_steal_back(state: GameState, stack: Stack, target_node: str) -> GameState:
    """å¥ªã„è¿”ã—å‡¦ç†"""

def bank_prisoners(state: GameState, player_id: str, stack: Stack) -> GameState:
    """æ•è™œç¢ºä¿"""
```

### 13.2 WebSocket API

#### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒ
```json
// æ¥ç¶š
{"type": "hello", "player_name": "Alice", "room_id": "test_room"}

// ãƒ«ãƒ¼ãƒ ä½œæˆ
{"type": "create_room", "config": {...}}

// ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹
{"type": "roll"}

// é§’é¸æŠ
{"type": "select_piece", "stack_id": "stack_123"}

// çµŒè·¯é¸æŠ
{"type": "select_path", "path": ["outer_7", "inner_n_0", "inner_n_1"]}

// ãƒãƒ£ãƒƒãƒˆ
{"type": "chat", "message": "Good game!"}
```

#### ã‚µãƒ¼ãƒ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
```json
// çŠ¶æ…‹æ›´æ–°
{"type": "state_update", "game_state": {...}}

// åˆæ³•æ‰‹é€šçŸ¥
{"type": "legal_moves", "moves": [...]}

// æ‰‹ç•ªé–‹å§‹
{"type": "turn_start", "player_id": "p1", "phase": "ROLL"}

// å‡ºç›®é€šçŸ¥
{"type": "dice_rolled", "value": 4, "player_id": "p1"}

// ã‚²ãƒ¼ãƒ çµ‚äº†
{"type": "game_over", "winner": "p2", "final_scores": {...}}

// ã‚¨ãƒ©ãƒ¼
{"type": "error", "message": "Invalid move"}
```

### 13.3 Redis è¨­è¨ˆ

#### ã‚­ãƒ¼æ§‹é€ 
```
room:{room_id}              â†’ JSON(GameState)
room:{room_id}:lock         â†’ SETNXç”¨ãƒ­ãƒƒã‚¯
player:{player_id}:room     â†’ room_idï¼ˆå†æ¥ç¶šç”¨ï¼‰
active_rooms                â†’ SET(room_ids)
```

#### Pub/Sub
```
channel: room:{room_id}     â†’ ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡ï¼ˆãƒãƒ«ãƒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¯¾å¿œï¼‰
```

### 13.4 Bot å®Ÿè£…

#### BotPlayer ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
```python
class BotPlayer:
    def __init__(self, player_id: str, difficulty: str):
        self.player_id = player_id
        self.difficulty = difficulty
    
    def choose_move(self, legal_moves: List[LegalMove], state: GameState) -> LegalMove:
        """åˆæ³•æ‰‹ã‹ã‚‰1ã¤é¸ã¶"""
        if self.difficulty == "random":
            return random.choice(legal_moves)
        elif self.difficulty == "heuristic":
            return self._heuristic_choice(legal_moves, state)
    
    def _heuristic_choice(self, moves: List[LegalMove], state: GameState) -> LegalMove:
        # å„ªå…ˆåº¦:
        # 1. æ•ç²ãŒèµ·ãã‚‹æ‰‹
        # 2. ãƒ›ãƒ¼ãƒ ã«åˆ°é”ã™ã‚‹æ‰‹
        # 3. å®‰å…¨ãƒã‚¹ã«ç§»å‹•ã™ã‚‹æ‰‹
        # 4. æ•µã‹ã‚‰æœ€ã‚‚é ã„ãƒã‚¹
        ...
```

---

## 14. ãƒ†ã‚¹ãƒˆè¨ˆç”»

### 14.1 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆpytestï¼‰
- `test_init_game()`: åˆæœŸåŒ–
- `test_roll_dice()`: ä¹±æ•°ç”Ÿæˆï¼ˆseedå›ºå®šï¼‰
- `test_generate_legal_moves()`: åˆæ³•æ‰‹åˆ—æŒ™
  - BOXã‹ã‚‰å‡ºã‚‹
  - é€šå¸¸ç§»å‹•
  - åˆ†å²é¸æŠ
  - æ•ç²å¯èƒ½ãªæ‰‹
- `test_apply_move_basic()`: åŸºæœ¬ç§»å‹•
- `test_apply_move_capture()`: æ•ç²
- `test_apply_move_steal_back()`: å¥ªã„è¿”ã—
- `test_safe_zone()`: å®‰å…¨ãƒã‚¹
- `test_home_banking()`: ãƒ›ãƒ¼ãƒ ç¢ºä¿
- `test_game_over()`: çµ‚äº†åˆ¤å®š
- `test_action_log_replay()`: ãƒªãƒ—ãƒ¬ã‚¤ï¼ˆæ±ºå®šæ€§ï¼‰

### 14.2 ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ†ã‚¹ãƒˆï¼ˆhypothesisï¼‰
```python
@given(st.integers(1, 6), st.lists(st.sampled_from(PlayerColor)))
def test_move_never_creates_invalid_state(dice_value, colors):
    # ã©ã‚“ãªå‡ºç›®ãƒ»è‰²ã®çµ„ã¿åˆã‚ã›ã§ã‚‚ã€ä¸æ­£ãªçŠ¶æ…‹ã«ãªã‚‰ãªã„
    ...
```

### 14.3 çµ±åˆãƒ†ã‚¹ãƒˆ
- 4ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¨¡æ“¬æ¥ç¶š
- ã‚²ãƒ¼ãƒ é–‹å§‹ã€œçµ‚äº†ã¾ã§ã®é€šã—
- å†æ¥ç¶šãƒ†ã‚¹ãƒˆ
- Botè£œå……ãƒ†ã‚¹ãƒˆ

---

## 15. Render ãƒ‡ãƒ—ãƒ­ã‚¤

### 15.1 render.yaml
```yaml
services:
  - type: web
    name: trap-the-cap
    env: python
    buildCommand: "pip install -r requirements.txt"
    startCommand: "uvicorn app.main:app --host 0.0.0.0 --port $PORT"
    envVars:
      - key: REDIS_URL
        fromService:
          name: trap-the-cap-redis
          type: redis
          property: connectionString
      - key: APP_ENV
        value: production

  - type: redis
    name: trap-the-cap-redis
    plan: starter
    maxmemoryPolicy: noeviction
```

### 15.2 ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
```python
@app.get("/healthz")
async def health_check():
    return {"status": "ok", "timestamp": time.time()}
```

---

## 16. ä»Šå¾Œã®æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ

### 16.1 ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°æ‹¡å¼µï¼ˆ2-6äººï¼‰
- ç›¤é¢JSONã‚’è¿½åŠ ï¼ˆboard_2p.json, board_6p.jsonï¼‰
- ãƒãƒ¼ãƒ‰é…ç½®ã‚’å‹•çš„ç”Ÿæˆã™ã‚‹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼

### 16.2 ã‚«ãƒ¼ãƒ‰è¦ç´ 
- ç‰¹æ®Šã‚«ãƒ¼ãƒ‰ï¼ˆç§»å‹•+2ã€ç›¸æ‰‹ã‚¹ã‚­ãƒƒãƒ—ç­‰ï¼‰
- `config.use_cards = true`

### 16.3 ãƒãƒ¼ãƒ æˆ¦
- 2 vs 2 ãƒ¢ãƒ¼ãƒ‰
- `config.team_mode = true`

### 16.4 AIå¼·åŒ–
- å¼·åŒ–å­¦ç¿’ï¼ˆDQNç­‰ï¼‰
- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ã®æ£‹è­œã‚’å­¦ç¿’

### 16.5 UIæ”¹å–„
- ReactåŒ–
- 3Dãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆThree.jsï¼‰

---

## 17. ã¾ã¨ã‚

ã“ã®ä»•æ§˜æ›¸ã«ã‚ˆã‚Šä»¥ä¸‹ãŒå®Ÿè£…å¯èƒ½:
âœ… ç”»åƒãƒ™ãƒ¼ã‚¹ã®æ­£ç¢ºãªç›¤é¢ï¼ˆ68ãƒãƒ¼ãƒ‰ï¼‰
âœ… å®Œå…¨ãªãƒ«ãƒ¼ãƒ«ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆæ•ç²/å¥ªã„è¿”ã—/å®‰å…¨åœ°å¸¯/ãƒ›ãƒ¼ãƒ ï¼‰
âœ… ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ï¼ˆWebSocket + Redisï¼‰
âœ… Botè£œå……
âœ… ãƒ†ã‚¹ãƒˆå¯èƒ½ãªè¨­è¨ˆ
âœ… Renderã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

**ä¸æ˜ç‚¹ã¯å…¨ã¦ config ã§åˆ‡æ›¿å¯èƒ½**ã«ã—ã¦ãŠã‚Šã€å¾Œã‹ã‚‰èª¿æ•´ã§ãã¾ã™ã€‚

---

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: ã‚³ãƒ¼ãƒ‰å®Ÿè£…ã«é€²ã¿ã¾ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚ä»•æ§˜ã®ç¢ºèªãƒ»ä¿®æ­£ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ
