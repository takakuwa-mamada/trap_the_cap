# Coppit（コピット / 帽子とりゲーム）実装仕様書 v3.0 FINAL

**作成日**: 2025-12-23  
**対象**: オンライン対戦版（FastAPI + WebSocket）  
**盤面**: 実際の画像ベース（外周リング + 中央X交差路 + 4つのBOX）  
**ルール確定根拠**: 
- 日本語要約: https://yama.kitashirakawa.jp/yama-blog/?p=1980
- Ravensburger版: https://shop.neu-icarus.com/items/13244102
- Wikipedia: https://en.wikipedia.org/wiki/Coppit

---

## 📋 目次

1. [用語集](#1-用語集)
2. [ゲーム概要](#2-ゲーム概要)
3. [盤面構造](#3-盤面構造)
4. [初期配置](#4-初期配置)
5. [手番フロー](#5-手番フロー)
6. [移動ルール](#6-移動ルール)
7. [捕獲ルール](#7-捕獲ルール)
8. [安全地帯（SAFE）](#8-安全地帯safe)
9. [帰還と確保](#9-帰還と確保)
10. [終了条件・勝利判定](#10-終了条件勝利判定)
11. [設定項目（Config）](#11-設定項目config)
12. [具体例（10ケース）](#12-具体例10ケース)
13. [不変条件（Invariants）](#13-不変条件invariants)

---

## 1. 用語集（Glossary）

| 用語 | 英語 | 説明 |
|------|------|------|
| 帽子 | Hat / Piece | 各プレイヤーの駒（1プレイヤー6個） |
| スタック | Stack | 同一マスに重なった帽子の束（捕獲の結果） |
| 操作主体 | Controller | スタックの最上位の帽子の色（そのプレイヤーが動かせる） |
| 捕虜 | Prisoners | スタック内で操作主体以外の帽子（捕獲された帽子） |
| BOX | Home Base | 各色の基地（ゲーム開始時・帰還時の場所） |
| 外周リング | Outer Ring | メインの周回経路（1周のループ） |
| 中央X | Central Cross | 中央を横断するX字の交差路（ショートカット） |
| 色マス | Colored Square | 外周・中央Xにある色付きマス（赤/青/黄/緑） |
| 安全地帯 | Safe Zone | 捕獲が起きないマス（グレーまたは同色マス） |
| 確保 | Banking | 捕虜をBOXに持ち帰り、盤面から除外すること |

---

## 2. ゲーム概要

### 2.1 基本情報
- **プレイヤー数**: 4人（拡張: 2-6人は将来対応）
- **色**: 🔴 RED、🔵 BLUE、🟡 YELLOW、🟢 GREEN
- **帽子数**: 各プレイヤー6個
- **サイコロ**: d6（1-6）
- **目的**: 相手の帽子を捕獲し、自分のBOXに持ち帰って確保する

### 2.2 勝利条件（確定）
**終了トリガー**: 盤上に残った帽子が**1色のみ**になったら終了  
**勝者判定**: **自分のBOX内にいる自色帽子の数が最多**のプレイヤー

根拠: Ravensburger版要約「盤上に残った帽子が一色になったら終了。各自の陣地にいる自色帽子の数を数え、最多が勝者」

### 2.3 参考ルールURL
- **日本語要約**: https://yama.kitashirakawa.jp/yama-blog/?p=1980
  - 「ねずみ色やぼうしと同じ色のマスは安全地帯」
  - 「どのほうこうにすすんでもかまいませんが、１かいのサイコロでは、一つのほうこうにしかすすめません」
- **Ravensburger版**: https://shop.neu-icarus.com/items/13244102
  - 「6が出ればもう一度振れる」
  - 終了条件・勝利判定
- **Wikipedia**: https://en.wikipedia.org/wiki/Coppit
  - 基本ルール概要

---

## 3. 盤面構造

### 3.1 全体レイアウト

```
        [RED BOX]
            ↕
   ┌────外周リング────┐
   │                  │
[YELLOW BOX]  中央X  [GREEN BOX]
   │                  │
   └──────────────────┘
            ↕
       [BLUE BOX]
```

### 3.2 構成要素

#### (A) BOX（Home Base）× 4
- 各色のBOX: 🔴 RED、🔵 BLUE、🟡 YELLOW、🟢 GREEN
- 位置: 盤面の4隅（画像参照）
- 接続: 各BOXは外周リングの最寄りマスに双方向接続（矢印）
- 役割:
  - ゲーム開始時、自色の6個の帽子がここに配置される
  - 帰還時、捕虜を確保する場所

#### (B) 外周リング（Outer Ring）
- マス数: 約48マス（画像から目視カウント）
- 構造: 1周のループ（cycle）
- マス種類:
  - 木目マス（ベージュ）: 通常マス（NORMAL）
  - 色マス（赤/青/黄/緑）: 各色4-6個程度（SAFE候補）
  - グレーマス: 存在する場合、全員にとってSAFE
- 接続: 隣接マスと双方向接続（i → i+1, i-1）

#### (C) 中央X（Central Cross）
- 構造: X字の交差路（ショートカット）
- 接続点: 外周リングの4箇所から侵入可能（画像の十字位置）
- マス数: 約8-12マス（十字の4本の枝 + 中心）
- マス種類:
  - 木目マス（NORMAL）
  - 色マス（各色1-2個）
- ルール: 
  - 1回の移動中は「1方向のみ」進める
  - 途中で折り返し不可

### 3.3 色マス配置（画像から推定）

| 色 | 外周リング | 中央X | 合計 |
|----|-----------|-------|------|
| 🔴 RED | 4-5個 | 1-2個 | 約6個 |
| 🔵 BLUE | 4-5個 | 1-2個 | 約6個 |
| 🟡 YELLOW | 4-5個 | 1-2個 | 約6個 |
| 🟢 GREEN | 4-5個 | 1-2個 | 約6個 |

※正確な配置は board_4p.json で確定

---

## 4. 初期配置

### 4.1 ゲーム開始時
- 各プレイヤーの6個の帽子は全て**自色のBOX内**に配置
- 盤面（外周・中央X）には帽子なし
- ターン順: RED → BLUE → GREEN → YELLOW（暫定、config化可能）

### 4.2 BOXから出る条件

**設定で切替可能** (`config.require_6_to_deploy`):

#### モードA: 任意の出目で出られる（デフォルト）
- `require_6_to_deploy = False`
- BOX内の帽子も通常の移動対象として選択可能
- 選んだ帽子を出目分だけ外周リングに進める

#### モードB: 6が必要（オプション）
- `require_6_to_deploy = True`
- 6が出た場合のみ、BOX内の帽子を外周に出せる
- 6以外が出た場合、BOX内の帽子は選択不可

**根拠**: 版によりルールが異なるため、切替可能にする

### 4.3 BOXから外周への接続
- RED BOX → outer_0（暫定、画像の矢印位置から推定）
- BLUE BOX → outer_12
- YELLOW BOX → outer_36
- GREEN BOX → outer_24

※正確な接続は board_4p.json で確定

---

## 5. 手番フロー

### 5.1 フェーズ遷移

```
WAITING → ROLL → SELECT_PIECE → SELECT_DIRECTION → MOVE → RESOLVE → (EXTRA_ROLL or NEXT_TURN)
```

### 5.2 各フェーズ詳細

#### WAITING
- ゲーム開始前、全プレイヤー接続待ち
- Bot補充タイマー起動（`config.bot_fill_timeout_sec`）

#### ROLL
- 現在のプレイヤーがサイコロを振る
- サーバが乱数生成（1-6、seed管理）
- 出目を全プレイヤーに通知

#### SELECT_PIECE
- プレイヤーが動かす帽子（またはスタック）を選択
- 選択可能:
  - BOX内の自色帽子（`require_6_to_deploy`に応じて）
  - 盤面上の自色が最上位のスタック
- サーバが選択可能性を検証

#### SELECT_DIRECTION
- 選んだ帽子の現在位置から、進める方向を選択
- 方向:
  - 外周: 時計回り（CW）または反時計回り（CCW）
  - 中央X: 4方向（北/東/南/西）
  - 分岐点: 外周続行 or 中央Xへ
- **制約**: 1回の出目の移動中は**1方向のみ**（途中で折り返し不可）

根拠: 「どのほうこうにすすんでもかまいませんが、１かいのサイコロでは、一つのほうこうにしかすすめません」

#### MOVE
- 選んだ方向に出目分だけマスを進む
- 各マスで以下を判定:
  1. 捕獲判定
  2. SAFE判定
  3. BOX到達判定

#### RESOLVE
- 最終マスでの処理:
  - 捕獲実行
  - BOX到達なら確保処理
- 状態更新
- 終了条件チェック

#### EXTRA_ROLL or NEXT_TURN
- 6が出て `config.extra_roll_on_6 = true` → ROLL へ戻る（同プレイヤー）
- それ以外 → 次のプレイヤーへ

根拠: 「6が出ればもう一度振れる」（Ravensburger版）

---

## 6. 移動ルール

### 6.1 基本移動
- **1手番1帽子**: 1回の手番で動かせるのは1つの帽子（またはスタック）のみ
- **出目分移動**: d6の出目分だけノードを進む
- **方向固定**: 1回の移動中は1方向のみ（途中で折り返し不可）

### 6.2 方向選択

#### 外周リング
- **時計回り（CW）**: outer_i → outer_(i+1)
- **反時計回り（CCW）**: outer_i → outer_(i-1)
- BOXから出る場合: 最初の1マス目で方向を決定

#### 中央X
- **4方向**: 北/東/南/西
- 外周からXへ: 接続点（Junction）で選択
- Xから外周へ: 出口で選択

### 6.3 分岐（Junction）
外周の特定マスから中央Xへ分岐可能:
- 例: `outer_10` → `cross_north_0` （北方向のX経路）

**分岐選択**:
- プレイヤーが「外周続行」or「中央Xへ」を選択
- 残り移動点を選んだ経路で消費

### 6.4 ぴったり不要
- 任意のマスに「ぴったり」止まる必要なし
- BOXへの帰還もぴったり不要（通過でも可）

### 6.5 余剰移動（Overshoot）
出目が余る場合:
- **外周**: ループし続ける（何周でも可）
- **中央X**: 端まで行ったら外周に出る（残りは外周で消費）
- **BOX**: 通過してそのまま外周に戻る（ループ）

---

## 7. 捕獲ルール

### 7.1 捕獲条件（確定）
以下の**全て**を満たすと捕獲発生:
1. 移動先のマスに**相手色の帽子（スタック）**がいる
2. そのマスが**安全地帯ではない**（後述）
3. **到達時のみ**捕獲（通過では捕獲しない、デフォルト）

### 7.2 捕獲の結果
```
移動前: マスAに [相手帽子a, 相手帽子b] のスタック（相手が操作主体）
移動後: [相手帽子a, 相手帽子b, 自分帽子] のスタック（自分が操作主体）
```

- 自分の帽子が最上位に乗る
- 相手のスタック全体が捕虜になる
- 次の手番から、このスタック全体を動かせる

### 7.3 スタックの捕獲
- スタック（捕虜を連れている帽子）も捕獲される
- 捕獲結果: 全ての帽子が1つのスタックに統合される

例:
```
状態: マスAに [Blue1, Blue2, Red1]（Redが操作主体）
     Green1が移動してマスAに到達
結果: [Blue1, Blue2, Red1, Green1]（Greenが操作主体）
      Blue1,2とRed1はGreen1の捕虜になる
```

### 7.4 同色の扱い
同色スタックがいるマスに到達した場合:
- **捕獲ではなく統合**
- 2つのスタックが1つに統合される
- 移動した帽子が最上位になる

例:
```
状態: マスAに [Red1, Red2]
     Red3が移動してマスAに到達
結果: [Red1, Red2, Red3]（1つのスタックに統合）
```

### 7.5 通過捕獲（オプション）
`config.capture_on_pass = false`（デフォルト）:
- 到達時のみ捕獲
- 通過したマスでは捕獲しない

`config.capture_on_pass = true`（オプション）:
- 出目の途中で通過したマスでも捕獲発生
- 捕獲後、残り移動点で進む

---

## 8. 安全地帯（SAFE）

### 8.1 SAFE の定義（P0確定）

**根拠**: 「ねずみ色やぼうしと同じ色のマスは安全地帯なので、そこではつかまえることができません」

SAFEマスの条件:
1. **グレーマス**（存在する場合）: 全色にとってSAFE
2. **同色マス**: 帽子と同じ色のマスは、その色にとってSAFE

例:
- Red1が赤マスにいる → SAFEなので捕獲されない
- Blue1が赤マスにいる → SAFEではない（捕獲される）
- Green1がグレーマスにいる → SAFE（どの色も捕獲されない）

### 8.2 SAFE判定のタイミング
- **捕獲される側がSAFE上にいるか**で判定
- 捕獲する側（移動してきた側）のマス色は関係ない

### 8.3 SAFEでの挙動
- SAFEマスにいる帽子は捕獲されない
- 複数の帽子が同じSAFEマスに共存可能（別スタックとして）

例:
```
状態: 赤マスにRed1がいる（SAFE）
     Blue1が移動して赤マスに到達
結果: Red1は捕獲されない
      [Red1] と [Blue1] が同じマスに別スタックとして共存
```

### 8.4 スタックのSAFE判定
スタックの場合、**最上位（操作主体）の色**でSAFE判定:

例:
```
状態: 赤マスに [Blue1(捕虜), Red1(最上位)] がいる
     Green1が移動して赤マスに到達
結果: Red1（最上位）が赤マスにいるのでSAFE
      捕獲されない
```

### 8.5 BOXのSAFE扱い
- 各色のBOX内は、その色にとって**常にSAFE**
- 相手色の帽子はBOXに侵入できない（暫定、config化可能）

---

## 9. 帰還と確保

### 9.1 BOXへの帰還
- 自分のBOXへ戻る条件: 移動経路にBOXが含まれる
- **ぴったり不要**: BOXを通過しても帰還扱い

### 9.2 捕虜の確保（Banking）

**確定ルール**:
- 自分のBOXに帰還したとき、**連れている捕虜**を確保できる
- 確保処理:
  1. 捕虜（スタック内の相手色帽子）をBOX内に移動
  2. 捕虜は盤面から除外（ゲームに戻らない）
  3. スコアとしてカウント（終了時の勝利判定用）

例:
```
状態: Red1が [Blue1(捕虜), Blue2(捕虜), Red1] を連れている
     Red1が RED BOX に到達
結果: Blue1, Blue2 を RED BOX に確保
      [Red1] のみがBOX内に残る（捕虜なし）
      Blue1, Blue2 は盤面から除外
```

### 9.3 自色帽子の帰還
- 自色帽子（捕虜を連れていない）がBOXに戻った場合:
  - BOX内に留まる
  - 次の手番で再び外周に出せる

### 9.4 確保された帽子の扱い
- 確保された捕虜は**ゲームから除外**
- 復活しない（デフォルト、`config.allow_respawn = false`）
- 将来拡張: 復活ルールを追加可能

---

## 10. 終了条件・勝利判定

### 10.1 終了条件（P0確定）

**根拠**: Ravensburger版要約「盤上に残った帽子が一色になったら終了」

終了トリガー:
- 盤面（外周リング + 中央X）に残っている帽子が**1色のみ**になったら終了

判定方法:
- 各手番後、盤面上の帽子の色を集計
- `len(set(colors_on_board)) == 1` なら終了

### 10.2 勝利判定（P0確定）

**根拠**: Ravensburger版要約「各自の陣地にいる自色帽子の数を数え、最多が勝者」

勝者判定:
1. 各プレイヤーのBOX内にいる**自色帽子の数**を数える
   - 自色帽子のみカウント（確保した捕虜はカウントしない）
2. 最多のプレイヤーが勝者

例:
```
終了時:
- RED BOX: Red帽子3個 + 確保済みBlue捕虜2個 → スコア3
- BLUE BOX: Blue帽子2個 → スコア2
- YELLOW BOX: Yellow帽子4個 → スコア4
- GREEN BOX: Green帽子1個 → スコア1

勝者: YELLOW（4個で最多）
```

### 10.3 引き分け処理
同点の場合:
- タイブレーク1: 盤面に残っている自色帽子の数（多い方が勝ち）
- タイブレーク2: 先にBOXに到達した順（ターン数で判定）
- それでも同じ → 引き分け（`winner = ["RED", "BLUE"]` 複数勝者）

### 10.4 その他の終了条件（オプション）
`config.max_turns` が設定されている場合:
- 設定ターン数で強制終了
- 上記の勝利判定を適用

---

## 11. 設定項目（Config）

実装で切替可能な全設定:

| 設定名 | 型 | デフォルト | 説明 |
|--------|-----|-----------|------|
| `max_players` | int | 4 | プレイヤー数 |
| `hats_per_player` | int | 6 | 各プレイヤーの帽子数 |
| `require_6_to_deploy` | bool | false | BOXから出るのに6が必要か |
| `extra_roll_on_6` | bool | true | 6が出たら追加ロール |
| `capture_on_pass` | bool | false | 通過マスで捕獲するか |
| `safe_by_color` | bool | true | 同色マスでSAFE有効 |
| `safe_by_gray` | bool | true | グレーマスでSAFE有効 |
| `allow_box_invasion` | bool | false | 相手BOXへの侵入可否 |
| `auto_bank_on_return` | bool | true | BOX帰還で自動確保 |
| `allow_respawn` | bool | false | 除外帽子の復活 |
| `win_mode` | enum | "box_count" | 勝利モード |
| `max_turns` | int | null | 最大ターン数（nullなら無制限） |
| `bot_fill_timeout_sec` | int | 30 | Bot補充待ち時間 |
| `allow_backward` | bool | true | 反時計回り移動の可否 |
| `direction_lock` | bool | true | 1回の移動で方向固定 |

---

## 12. 具体例（10ケース）

### 例1: BOXから出る（任意の出目）
- **設定**: `require_6_to_deploy = false`
- **状態**: Red1がRED BOX内、盤面は空
- **出目**: 3
- **選択**: Red1をBOXから出す、時計回り
- **期待結果**: Red1が `outer_0` から3マス進んで `outer_3` に到達
- **スタック**: `[Red1]` at outer_3

### 例2: BOXから出る（6が必要）
- **設定**: `require_6_to_deploy = true`
- **状態**: Blue1がBLUE BOX内
- **出目**: 3
- **期待結果**: Blue1は選択不可（6以外なので出られない）
- **出目**: 6
- **期待結果**: Blue1をBOXから出せる

### 例3: 基本捕獲
- **状態**: 
  - Blue1が `outer_10` にいる（NORMAL、青マスではない）
  - Red1が `outer_7` にいる
- **出目**: 3（Redの手番）
- **選択**: Red1を時計回りに動かす
- **経路**: outer_7 → outer_8 → outer_9 → outer_10
- **期待結果**: 
  - `outer_10` に到達
  - Blue1を捕獲
  - スタック: `[Blue1(捕虜), Red1(操作主体)]` at outer_10

### 例4: SAFE（同色マス）
- **状態**: 
  - Blue1が `outer_15`（**青マス**）にいる
  - Red1が `outer_12` にいる
- **出目**: 3
- **選択**: Red1を動かす
- **経路**: outer_12 → outer_13 → outer_14 → outer_15
- **期待結果**: 
  - `outer_15` に到達
  - Blue1は青マス上でSAFEなので捕獲**しない**
  - `[Blue1]` と `[Red1]` が同じマスに別スタックとして共存

### 例5: スタックの捕獲
- **状態**: 
  - スタック `[Blue1(捕虜), Red1(操作主体)]` が `outer_20` にいる
  - Green1が `outer_17` にいる
- **出目**: 3（Greenの手番）
- **期待結果**: 
  - `outer_20` に到達
  - スタック全体を捕獲
  - 新スタック: `[Blue1, Red1, Green1]` at outer_20
  - Green1が操作主体

### 例6: 帰還と確保
- **状態**: 
  - スタック `[Blue1(捕虜), Blue2(捕虜), Red1]` が `outer_45` にいる
  - RED BOXは `outer_0` に接続
- **出目**: 5
- **選択**: Red1を動かす、BOX方向へ
- **経路**: outer_45 → outer_46 → outer_47 → outer_0 → RED BOX
- **期待結果**: 
  - RED BOXに到達
  - Blue1, Blue2を確保（BOX内に移動、盤面から除外）
  - `[Red1]` のみがRED BOX内に残る

### 例7: 中央Xショートカット
- **状態**: Red1が `outer_10`（Xへの接続点）にいる
- **出目**: 4
- **選択**: 中央Xへ進む
- **経路**: outer_10 → cross_n_0 → cross_n_1 → cross_center → cross_s_1
- **期待結果**: `cross_s_1` に到達（反対側へ横断）

### 例8: 6で追加ロール
- **設定**: `extra_roll_on_6 = true`
- **出目**: 6
- **選択**: Red1を6マス進める
- **期待結果**: 移動後、もう一度ROLLフェーズになる（同じプレイヤー）

### 例9: 同色統合
- **状態**: 
  - Red1が `outer_10` にいる
  - Red2が `outer_8` にいる
- **出目**: 2（Redの手番、Red2を動かす）
- **期待結果**: 
  - `outer_10` に到達
  - 捕獲ではなく統合
  - スタック: `[Red1, Red2]` at outer_10（Red2が最上位）

### 例10: 終了条件
- **状態**: 
  - 盤面にRedの帽子のみ残っている（他色は全てBOXまたは確保済み）
- **期待結果**: 
  - ゲーム終了
  - 各BOX内の自色帽子をカウント
    - RED: 3個
    - BLUE: 1個
    - YELLOW: 2個
    - GREEN: 4個
  - 勝者: GREEN（4個で最多）

---

## 13. 不変条件（Invariants）

実装時に常に満たすべき条件:

### 13.1 帽子の総数
```python
total_hats = sum(len(box) + len(stack) for box, stack in all_locations)
assert total_hats == config.max_players * config.hats_per_player
```

### 13.2 スタックの一貫性
```python
for stack in all_stacks:
    assert len(stack.pieces) >= 1  # 空スタックは存在しない
    assert stack.controller == stack.pieces[-1].color  # 最上位が操作主体
```

### 13.3 SAFE判定の対称性
```python
# SAFEマス上では捕獲が起きない
if is_safe(target_node, target_stack):
    assert no_capture_occurred
```

### 13.4 BOX内の帽子
```python
for player in players:
    box_hats = [h for h in player.box if h.color == player.color]
    # BOX内の自色帽子 + 盤面の自色帽子 + 除外された自色帽子 = hats_per_player
```

### 13.5 方向固定
```python
# 1回の移動中、方向が途中で変わらない
for move in single_turn_moves:
    assert move.direction == first_move.direction
```

---

## 14. 次のステップ

この仕様書により以下が実装可能:
✅ P0確定ルールに基づく完全な仕様
✅ 画像ベースの正確な盤面構造
✅ 設定で切替可能な柔軟性
✅ テスト可能な具体例10ケース
✅ 不変条件による検証

**次**: board_4p.json の作成（画像から正確にノードを抽出）

---

**END OF SPEC v3.0**
